<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AEGIS V20 - STRATÃ‰GIE FINALE</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root { --bg: #040508; --card: #0d1117; --buy: #00ff88; --sell: #ff3366; --primary: #2962ff; --warn: #ffcc00; }
body { font-family: 'Inter', sans-serif; background: var(--bg); color: white; margin: 0; padding: 10px; text-align: center; }
.container { background: var(--card); border-radius: 20px; padding: 15px; border: 1px solid #30363d; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }

.status-bar { font-size: 10px; color: var(--primary); font-weight: bold; letter-spacing: 1px; margin-bottom: 10px; }

.display-zone {
    height: 200px;
    background: #000;
    border-radius: 15px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border: 4px solid #1a1f26;
    margin: 15px 0;
    transition: 0.2s;
}

.sig-val { font-size: 42px; font-weight: 900; margin: 5px 0; }
.data-grid { font-size: 10px; color: #8b949e; text-align: left; width: 85%; line-height: 1.6; border-top: 1px solid #1a1f26; pt: 8px; }

.advice-box {
    background: rgba(255, 204, 0, 0.1);
    border: 1px solid var(--warn);
    border-radius: 10px;
    padding: 10px;
    margin-bottom: 15px;
    display: none;
}

button { 
    background: #ffffff; color: #000; border: none; padding: 20px; border-radius: 12px; 
    width: 100%; font-weight: 900; font-size: 16px; cursor: pointer;
}
button:disabled { opacity: 0.3; cursor: not-allowed; }
</style>
</head>
<body>

<div class="container">
    <div class="status-bar">SYSTEM ALGO SYNC: 100%</div>
    
    <div id="main-box" class="display-zone">
        <div id="label" style="font-size: 10px; color: #484f58;">SCANNER DE CONFLUENCE</div>
        <div id="signal" class="sig-val">---</div>
        <div id="data-list" class="data-grid"></div>
    </div>

    <div id="advice" class="advice-box">
        <span style="font-size: 9px; color: var(--warn); font-weight: bold;">CONSEIL D'EXPIRATION</span>
        <div id="exp-val" style="font-size: 16px; font-weight: bold;">--</div>
    </div>

    <button id="btn-trigger" onclick="executeStrategy()">DÃ‰TECTER LE SIGNAL</button>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

// =====================
// FONCTIONS INDICATEURS
// =====================
function EMA(values, period) {
    const k = 2 / (period + 1);
    let ema = values[0];
    for (let i = 1; i < values.length; i++) {
        ema = values[i] * k + ema * (1 - k);
    }
    return ema;
}

function RSI(values, period = 14) {
    let gains = 0, losses = 0;
    for (let i = values.length - period; i < values.length - 1; i++) {
        const diff = values[i + 1] - values[i];
        if (diff > 0) gains += diff; else losses -= diff;
    }
    return 100 - (100 / (1 + (gains / (losses || 1))));
}

function MACD(values) {
    const macdLine = EMA(values, 12) - EMA(values, 26);
    const signalLine = EMA(values.map((v,i,a)=> i===0 ? 0 : EMA(a.slice(0,i+1),12)-EMA(a.slice(0,i+1),26)), 9);
    const histogram = macdLine - signalLine;
    return {macdLine, signalLine, histogram};
}

// =====================
// RÃ‰CUPÃ‰RATION DES PRIX RÃ‰ELS
// =====================
async function fetchPrices() {
    try {
        const resp = await fetch('https://api.binance.com/api/v3/klines?symbol=EURUSDT&interval=1m&limit=200');
        const data = await resp.json();
        return data.map(k => parseFloat(k[4])); // prix de clÃ´ture
    } catch(e) {
        console.error(e);
        // fallback simulÃ©
        return Array.from({length: 60}, () => 1.0820 + Math.random() * 0.005);
    }
}

// =====================
// LOGIQUE DE SIGNAL
// =====================
async function executeStrategy() {
    const btn = document.getElementById('btn-trigger');
    const sig = document.getElementById('signal');
    const box = document.getElementById('main-box');
    const dataList = document.getElementById('data-list');
    const advice = document.getElementById('advice');
    const expVal = document.getElementById('exp-val');

    btn.disabled = true;
    sig.innerText = "...";
    advice.style.display = "none";

    const prices = await fetchPrices();

    const ema50 = EMA(prices, 50);
    const ema200 = EMA(prices, 200);
    const rsiVal = RSI(prices);
    const macd = MACD(prices);

    let result = "NEUTRE";
    let color = "#484f58";
    let expiration = "ATTENDRE";

    const trendUp = ema50 > ema200;
    const trendDown = ema50 < ema200;

    if (trendUp && rsiVal > 50 && macd.macdLine > macd.signalLine) {
        result = "ACHAT ðŸŸ¢";
        color = "var(--buy)";
        expiration = rsiVal > 65 ? "1 MINUTE (FLASH)" : "5 MINUTES (SÃ›R)";
    } 
    else if (trendDown && rsiVal < 50 && macd.macdLine < macd.signalLine) {
        result = "VENTE ðŸ”´";
        color = "var(--sell)";
        expiration = rsiVal < 35 ? "1 MINUTE (FLASH)" : "5 MINUTES (SÃ›R)";
    }

    sig.innerText = result;
    sig.style.color = color;
    box.style.borderColor = color;

    dataList.innerHTML = `
        â€¢ EMA 50: ${ema50.toFixed(5)} (${trendUp ? 'HAUSSE' : 'BAISSE'})<br>
        â€¢ EMA 200: ${ema200.toFixed(5)}<br>
        â€¢ RSI (14): ${rsiVal.toFixed(2)}<br>
        â€¢ MACD: ${macd.macdLine.toFixed(6)}<br>
        â€¢ Signal: ${macd.signalLine.toFixed(6)}<br>
        â€¢ Histogramme: ${macd.histogram.toFixed(6)}
    `;

    if (result !== "NEUTRE") {
        expVal.innerText = expiration;
        advice.style.display = "block";
    }

    // Verrouillage 20s
    let count = 20;
    const timer = setInterval(() => {
        count--;
        if(count <= 0) {
            clearInterval(timer);
            btn.disabled = false;
            btn.innerText = "DÃ‰TECTER LE SIGNAL";
        } else {
            btn.innerText = `PATIENTER (${count}s)`;
        }
    }, 1000);
}
</script>
</body>
    </html>
