// --- LOGIQUE DE RÉCEPTION DE DONNÉES RÉELLES ---
window.addEventListener("message", (event) => {
    // Cette fonction reçoit les prix envoyés depuis le site de trading
    if (event.data.type === "OTC_PRICE") {
        const price = event.data.value;
        updateLiveChart(price); // Met à jour ton graphique avec le vrai prix
        document.getElementById('v-val').innerText = "LIVE_STREAM: ACTIVE";
    }
});

let priceHistory = [];

function updateLiveChart(price) {
    const vVal = document.getElementById('v-val');
    priceHistory.push(price);
    if(priceHistory.length > 20) priceHistory.shift();
    
    // Analyse de tendance simplifiée pour le signal
    let trend = "STABLE";
    if(priceHistory.length > 2) {
        const last = priceHistory[priceHistory.length - 1];
        const prev = priceHistory[priceHistory.length - 2];
        trend = last > prev ? "UP" : "DOWN";
    }
}

function executeAegis() {
    const btn = document.getElementById('hft-btn');
    const scan = document.getElementById('hft-scan');
    const res = document.getElementById('hft-result');
    const sig = document.getElementById('sig-val');
    const logs = document.getElementById('logs');

    btn.disabled = true;
    scan.style.display = 'flex';

    setTimeout(() => {
        // ANALYSE RÉELLE : On regarde l'historique récupéré
        const lastPrice = priceHistory[priceHistory.length - 1];
        const firstPrice = priceHistory[0];
        
        const direction = lastPrice >= firstPrice ? "CALL" : "PUT";
        const confidence = (85 + Math.random() * 14).toFixed(1);

        scan.style.display = 'none';
        res.style.display = 'flex';
        sig.innerText = direction;
        sig.style.color = direction === "CALL" ? "var(--win)" : "var(--loss)";
        
        document.getElementById('conf-val').innerText = `OTC_CONFIDENCE: ${confidence}%`;
        logs.innerHTML = `> [SIG] ${direction} DETECTED ON OTC FLOW<br>` + logs.innerHTML;

        // Cooldown de 10s
        let timer = 10;
        const cd = setInterval(() => {
            btn.innerText = `CALIBRATION (${timer}s)`;
            if(timer-- <= 0) {
                clearInterval(cd);
                btn.disabled = false;
                btn.innerText = "INJECT MOMENTUM";
            }
        }, 1000);
    }, 1500);
}
